# Ядро до начала времён

Для стабильной работы системы, ядро должно запустить необходимые процессы, которые будут поддерживать её работоспособность. Ещё до того как будет подключен суперпользователь, необходимо выполнять процедуры подключения устройств, разпознование и создание файловой системы и многое другое. Данные процессы отвязаны от какого-либо пользователя и не имеют какой-либо оболочки исполнения типа bash. Всех этих демонов запускает процесс инициализации - **systemd**, PID данного процесса всегда будет 1. 

Однако выпускать демона в самостоятельное плавание для обслуживания ОС не совсем безопасная затея. Необходимо контролировать его поведение, некоторые демоны могут конфликтовать друг с другом, других нельзя запускать пока не запущены другие, некоторые могут с первого раза не запуститься. Поэтому каждый демонов обворачивают в сервисы. Это определённый свод правил о том как должен вести себя процесс в течении своего жизненного цикла. Демонов и сервисы к ним можно писать самостоятельно. И так, для кажой задачи поддерживающей работоспособность системы создаётся отдельный демон. Некоторые демоны объеденены в группы, которые необходимы для выполнения таргета. Объект манипуляции через который **systemd** взаимодействует с процессами называется **unit**.

Введите 

```bash
systemctl get-default
```

и вы увидите, что цель(target) по умолчанию, кототорую стремится выполнить система - это организовать графический интерфейс взаимодействия с пользователем. 

Но перед достижением этой цели, необходимо выполнить несколько предыдущих. Чтобы увидеть эту зависимость введите.

```bash
systemctl list-dependencies graphical.targer
```

![graphical_target_dependencies](/Users/egordmitriev/Dropbox/introducion_to_Linux/8_Systemd/images/graphical_target_dependencies.png)

Как видите, использование **graphical.target** предполагает использование **multi-user.target**, внутри которого огромное количество **юнитов**.

На серверах обычно не используют графику для экономии ресурсов, поэтому по-умолчанию на них установлена цель **multi-user.target**.

Но перед тем как вносить изменения давайте взгляем на директорию **/usr/lib/systemd**.

```bash
ls /usr/lib/systemd
```

Здесь содержатся все файлы юнитов котоые были созданы в момент установки системы или когда вы устанавливали какую-либо программу. 

## *.target

Теперь взглянем на файл цели. Данный файл расположен в /usr/lib/systemd/system.

```bash
systemctl cat graphical.target
```

- **Requires** - зависимость необходимая для выполнения текущего таргета.
- **Wants** - Сервис, который должен загрузиться если таковой имеется. Если сервиса нет или он не прогрузился, таргет всё равно прогрузится.  **display-manager.service** - Это та программа, которая запрашивает у нас логин при входе в систему.
- **Conflict** - таргет не может одновременно работать с этими сервисами и таргетами. Перечисленные здесь таргеты и сервисы будут остановлены при запуске текущего таргета.
- **Before** - перечень операций, выполняющихся перед выполнением таргета.
- **After** - перечень сервисов и таргетов, после которых грузится текущий таргет
- **AllowIsolate** - можно ли использовать этот таргет как состояние, к которому можно перейти с помощю команды **systemctl isolate**.

Таргеты - это группа юнитов и некоторые из них можно использовать как состояние загрузки операционной системы. **graphical.target** или **multi-user.targer**<br>Другие нельзя использовать как готовое состояние системы. **network.target** или **rescue.target**

Давайте взглянием как запускается система на серверах.

```bash
sudo systemctl set-default multi-user.target
```

Выполните перезагрузку. Задерживаться здесь особо не будем, просто установите обратно графическую среду как стандартное состояние загрузки ОС.

## *.service

Чуть выше мы упомянули про **display-manger.service**. Давайте взглянем на файл описывающий его.

```bash
cat /usr/lib/systemd/system/gdm.service
```

#### секции

1. Unit - описание юнита, аналогично **.target**
2. Service - хранит информацию о том как сервис запускает/останавливает демона.

  - [ ] ExecStart - запускаемый процесс
  - [ ] ExecStopPost - скрипт, выполняемый после остановки демона
3. Install - опции используемы при установке демона.

Включение/выключение сервиса сопровождается созданием/удалением символической ссылки.

```bash
systemctl disable gdm
```

```bash
systemctl enable gdm
```

Запустив данные команды, обратите внимание на каталог в котором создаются ссылки.

в каталоге **/etc/systemd/system/** хранятся ссылки означающие, что сервис включён. А сами сервисы хранятся в   **/usr/lib/systemd/system**. Тут же могут находиться сервису установленные через **RPM**. Не редактируйте напрямую содержимое этой директории, а написанные вручную сервисы принято располагать **/etc/systemd/system/**.<br> Так же есть каталог **/run/systemd/system/**, который содержит файл юнитов, которые сгенерировались автоматически. Файлы в этом каталоге обладают наибольшим приоритетом, и при конфликте настроек значение берётся именно из юнита определённого в данном каталоге. Вторыми по значимости файлы располагаются в **/etc/systemd/system** и в последнюю очередь учитывается каталог **/usr/lib/systemd/system**.



## *.socket

Ещё один интересный юнит, создающий методы приложения для общения с другими приложениями. Сокет может объявлять как файлы, так и порты на которых **systemd** будет слушать входящие подключения. Данный сервис не работает всё время, а только в когда устанавливается соединение. Каждому сокету требуется отдельный сервисный файл.

```bash
cat /usr/lib/systemd/system/cockpit.socket
```

- **ListenStream** - Определяется **TCP** порт на котором **Systemd** слушает входящие подключения. 
- **ListenDatagram** - Устанавливается для **UDP** порта вместо **ListenStream**.



## *.mount

```bash
cat /usr/lib/systemd/system/tmp.mount
```

- **Mount** - Определяет точку монтирования. Перечисленные здесь параменты вы обычно указываете когда передаёте аргументы утилите **mount**.

### результат работы systemd status

- Loaded - запущенный **unit** файл, текущее состояние, **vendor preset** указывает, что сервис был установлен вместе с системой.
- Active(running) - unit запущен одним или более активными процессами. 
- Active(exited) - unit успешно завершил разовый запуск
- Active(waiting) - unit запущен и ожидает события.
- inactive(dead) - unit не запущен.
- Enabled - unit запускается при загрузке системы
- Disabled - unit не запускается при старте системы.
- Static - unit не может стартовать при запуске системы, но может быть запущен другими unit' ами.



## Советы:

- чтобы посмотреть список доступных юнитов, используйте команду 

     ```bash
    systemctl -t help
    ```

- Для того чтобы посмотреть зависимости  для **.target** группы, введите

  ```bash
  systemctl list-dependencies [name.target]
  ```

- Посмотреть какие опции доступны при настройке этого сервиса

  ```bash
  systemctl show sshd
  ```

  

